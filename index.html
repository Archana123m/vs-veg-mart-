<!DOCTYPE html>
<html lang="kn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V.S. Vegetable Mart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .total-banner { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #064e3b; color: white; padding: 1.2rem; 
            z-index: 9999; display: none; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
            text-align: center; font-weight: bold; cursor: pointer;
        }
        #cart-sidebar { 
            position: fixed; right: -100%; top: 0; bottom: 0; 
            width: 100%; max-width: 400px; background: white; 
            z-index: 10000; transition: 0.3s; padding: 20px; 
            box-shadow: -10px 0 30px rgba(0,0,0,0.2); 
            overflow-y: auto;
        }
        #cart-sidebar.active { right: 0; }
        .veg-card { border: 1px solid #eee; border-radius: 10px; overflow: hidden; background: white; transition: transform 0.2s; }
        .veg-card:active { transform: scale(0.98); }
    </style>
</head>
<body class="bg-gray-50 pb-24">

    <header class="bg-green-800 text-white p-6 text-center sticky top-0 z-50 shadow-md">
        <h1 class="text-2xl font-bold">V.S. VEGETABLE MART</h1>
        <p class="text-green-300">ðŸ“ž 9980764752</p>
    </header>

    <div class="p-4 sticky top-20 bg-gray-50 z-40">
        <input type="text" id="searchInput" onkeyup="filterVeg()" placeholder="Search vegetables (e.g. Tomato)..." class="w-full p-4 border-2 border-green-100 rounded-xl shadow-sm focus:border-green-500 outline-none">
    </div>

    <main id="shop-container" class="p-4 grid grid-cols-2 gap-4 max-w-4xl mx-auto"></main>

    <div id="cart-total" class="total-banner" onclick="toggleCart(true)">
        <div class="flex justify-between items-center px-4">
            <span class="text-lg">View Cart ðŸ›’</span>
            <span class="text-xl">Total: â‚¹<span id="total-val">0</span></span>
        </div>
    </div>

    <div id="cart-sidebar">
        <div class="flex justify-between mb-4 border-b pb-4">
            <h2 class="font-bold text-2xl text-green-800">Your Order</h2>
            <button onclick="toggleCart(false)" class="text-2xl font-bold p-2">âœ•</button>
        </div>
        
        <div id="cart-list" class="space-y-4 mb-6 min-h-[100px]">
            </div>

        <div class="border-t pt-4 space-y-4">
            <div>
                <label class="text-sm text-gray-600 block mb-1">Full Name</label>
                <input type="text" id="cust_name" placeholder="Enter your name" class="w-full p-3 border rounded-lg focus:ring-2 ring-green-500">
            </div>
            <div>
                <label class="text-sm text-gray-600 block mb-1">Phone Number</label>
                <input type="tel" id="cust_phone" placeholder="Mobile number" class="w-full p-3 border rounded-lg focus:ring-2 ring-green-500">
            </div>
            <button onclick="sendOrder()" class="w-full bg-green-700 hover:bg-green-800 text-white py-4 rounded-xl font-bold text-lg transition shadow-lg">
                ORDER ON WHATSAPP
            </button>
        </div>
    </div>

    <script>
        // Updated Link
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSombdppmWqAYqrvhAFj7P1Samea_9O1i2sJyU1EsLhiPsuS1T6KaW4QiVlV1XN08xSGzX8fNL7kZqU/pub?output=csv';
        const WHATSAPP_NUM = '919980764752';
        let allItems = [];

        async function loadData() {
            try {
                const response = await fetch(SHEET_URL);
                const data = await response.text();
                // Split by rows and handle potential CSV quoting issues
                const rows = data.split(/\r?\n/).slice(1); 
                
                allItems = rows.map(row => {
                    const cols = row.split(',');
                    return { 
                        name: cols[1]?.trim(), 
                        price: parseFloat(cols[2]) || 0, 
                        unit: cols[3]?.trim() || 'kg', 
                        img: cols[4]?.trim(), 
                        stock: cols[7]?.trim().toLowerCase() 
                    };
                }).filter(i => i.name && i.stock !== 'out');
                
                render(allItems);
            } catch (e) {
                console.error(e);
                document.getElementById('shop-container').innerHTML = `<p class="col-span-2 text-center text-red-500">Failed to load shop data. Please refresh.</p>`;
            }
        }

        function render(items) {
            const container = document.getElementById('shop-container');
            if(items.length === 0) {
                container.innerHTML = `<p class="col-span-2 text-center text-gray-500 py-10">No vegetables found.</p>`;
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="veg-card p-3 shadow-sm">
                    <img src="${item.img || 'https://via.placeholder.com/150?text=Veggie'}" 
                         alt="${item.name}" 
                         class="w-full h-32 object-cover rounded-lg mb-2"
                         onerror="this.src='https://via.placeholder.com/150?text=Veggie'">
                    <h3 class="font-bold text-gray-800 text-sm h-10 overflow-hidden line-clamp-2">${item.name}</h3>
                    <p class="text-green-700 font-bold mb-2">â‚¹${item.price} / <span class="text-xs text-gray-500">${item.unit}</span></p>
                    <input type="number" min="0" placeholder="Qty" 
                           oninput="updateTotal()" 
                           data-name="${item.name}" 
                           data-price="${item.price}" 
                           class="qty-input w-full border-2 border-gray-100 p-2 text-center rounded-lg focus:border-green-500 outline-none">
                </div>
            `).join('');
        }

        function updateTotal() {
            let total = 0;
            document.querySelectorAll('.qty-input').forEach(input => {
                const val = parseFloat(input.value) || 0;
                total += val * parseFloat(input.dataset.price);
            });
            document.getElementById('total-val').innerText = total.toFixed(2);
            document.getElementById('cart-total').style.display = total > 0 ? 'block' : 'none';
        }

        function toggleCart(open) {
            const sidebar = document.getElementById('cart-sidebar');
            sidebar.classList.toggle('active', open);
            
            if(open) {
                let html = "";
                let subtotal = 0;
                document.querySelectorAll('.qty-input').forEach(input => {
                    const qty = parseFloat(input.value) || 0;
                    if(qty > 0) {
                        const itemTotal = qty * parseFloat(input.dataset.price);
                        subtotal += itemTotal;
                        html += `
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                            <div>
                                <p class="font-bold text-gray-800">${input.dataset.name}</p>
                                <p class="text-xs text-gray-500">${qty} units x â‚¹${input.dataset.price}</p>
                            </div>
                            <span class="font-bold text-green-700">â‚¹${itemTotal.toFixed(2)}</span>
                        </div>`;
                    }
                });
                document.getElementById('cart-list').innerHTML = html || `<p class="text-center text-gray-400 py-10">Your cart is empty</p>`;
            }
        }

        function sendOrder() {
            const name = document.getElementById('cust_name').value.trim();
            const phone = document.getElementById('cust_phone').value.trim();
            
            if(!name || !phone) {
                alert("Please enter your Name and Phone Number to proceed.");
                return;
            }
            
            let itemDetails = "";
            let total = 0;
            document.querySelectorAll('.qty-input').forEach(i => {
                const qty = parseFloat(i.value) || 0;
                if(qty > 0) {
                    const price = parseFloat(i.dataset.price);
                    itemDetails += `â€¢ ${i.dataset.name}: ${qty} (â‚¹${qty * price})\n`;
                    total += qty * price;
                }
            });

            if(total === 0) return alert("Your cart is empty!");
            
            const message = `*NEW ORDER - V.S. VEGETABLE MART*\n\n` +
                            `ðŸ‘¤ *Name:* ${name}\n` +
                            `ðŸ“ž *Phone:* ${phone}\n\n` +
                            `ðŸ›’ *ITEMS:*\n${itemDetails}\n` +
                            `ðŸ’° *TOTAL AMOUNT: â‚¹${total.toFixed(2)}*\n\n` +
                            `Please confirm my order.`;
            
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUM}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function filterVeg() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allItems.filter(i => i.name.toLowerCase().includes(query));
            render(filtered);
        }

        // Initial Load
        loadData();
    </script>
</body>
</html>

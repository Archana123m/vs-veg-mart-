<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V.S. Vegetable Mart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hero-bg {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), 
                        url('https://images.unsplash.com/photo-1542838132-92c53300491e?auto=format&fit=crop&w=1350&q=80');
            background-size: cover; background-position: center;
        }
        .veg-card { border: 1px solid #eee; border-radius: 12px; overflow: hidden; background: white; }
        #cart-sidebar, #order-history-sidebar { 
            position: fixed; right: -100%; top: 0; bottom: 0; 
            width: 100%; max-width: 450px; background: white; 
            z-index: 10000; transition: 0.3s; padding: 20px; 
            box-shadow: -10px 0 30px rgba(0,0,0,0.2); overflow-y: auto; 
        }
        .active { right: 0 !important; }
        .category-tab { cursor: pointer; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; transition: 0.3s; border: 1px solid #e2e8f0; white-space: nowrap; }
        .category-tab.active-tab { background-color: #166534; color: white; border-color: #166534; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-50 pb-24">

    <header class="hero-bg text-white p-8 text-center shadow-lg">
        <h1 class="text-3xl font-extrabold mb-2">V.S. VEGETABLE MART</h1>
        <p class="text-green-300 italic mb-4">"Farm fresh Vegetables are provided for all kind of occasions"</p>
        <div class="flex flex-wrap justify-center gap-3 mt-4">
            <span class="bg-white/20 backdrop-blur-md px-4 py-2 rounded-full text-sm font-bold">üìû 9980764752</span>
            <button onclick="toggleHistory(true)" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-full text-sm font-bold shadow-md">üìú Order History</button>
        </div>
    </header>

    <div class="p-4 max-w-4xl mx-auto sticky top-0 bg-gray-50/90 z-40 space-y-3">
        <input type="text" id="searchInput" onkeyup="filterVeg()" placeholder="Search vegetables (English)..." class="w-full p-4 border-2 border-green-100 rounded-xl outline-none focus:border-green-600 shadow-sm">
        
        <div id="category-tabs" class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
            <div onclick="setCategory('All')" class="category-tab active-tab" id="tab-All">All</div>
        </div>
    </div>

    <main id="shop-container" class="p-4 grid grid-cols-2 md:grid-cols-3 gap-4 max-w-4xl mx-auto"></main>

    <div id="cart-total" class="fixed bottom-0 left-0 right-0 bg-green-800 text-white p-4 text-center font-bold hidden z-50 cursor-pointer" onclick="toggleCart(true)">
        REVIEW ORDER & DELIVERY: ‚Çπ<span id="total-val">0</span>
    </div>

    <div id="cart-sidebar">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="font-bold text-2xl">Checkout</h2>
            <button onclick="toggleCart(false)" class="text-3xl">√ó</button>
        </div>
        <div id="cart-list" class="space-y-3 mb-8 max-h-60 overflow-y-auto p-2 bg-gray-50 rounded"></div>
        <div class="space-y-4">
            <h3 class="font-bold text-lg text-green-800">Customer Details (Optional)</h3>
            <input type="text" id="cust_name" placeholder="Full Name" class="w-full p-3 border rounded-lg outline-none focus:ring-2 ring-green-500">
            <input type="tel" id="cust_phone" placeholder="WhatsApp Number" class="w-full p-3 border rounded-lg outline-none focus:ring-2 ring-green-500">
            <div class="space-y-2">
                <div class="flex gap-2">
                    <input type="text" id="cust_address" placeholder="Delivery Address" class="flex-1 p-3 border rounded-lg outline-none">
                    <button onclick="getLocation()" class="bg-blue-600 text-white px-3 rounded-lg text-xs font-bold shadow-sm">üìç GPS</button>
                </div>
                <p id="geo-status" class="text-xs text-gray-500 italic"></p>
            </div>
            <button onclick="sendOrder()" class="w-full bg-green-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-green-800 transition">SEND ORDER ON WHATSAPP</button>
        </div>
    </div>

    <div id="order-history-sidebar">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="font-bold text-2xl text-green-800">Past Orders</h2>
            <button onclick="toggleHistory(false)" class="text-3xl">√ó</button>
        </div>
        <div class="mb-6">
            <p class="text-sm text-gray-600 mb-2">Find records by phone number:</p>
            <div class="flex gap-2">
                <input type="tel" id="history_search_phone" placeholder="Enter Phone Number" class="flex-1 p-3 border rounded-lg outline-none focus:ring-2 ring-green-500">
                <button onclick="searchHistory()" class="bg-green-600 text-white px-4 rounded-lg font-bold">Search</button>
            </div>
        </div>
        <div id="history-results" class="space-y-4 pb-10"></div>
        <div id="vendor-tools" class="mt-10 border-t pt-4 hidden">
            <button onclick="clearHistory()" class="w-full border border-red-200 text-red-500 py-2 rounded-lg text-sm font-bold hover:bg-red-50 transition">üóë Clear History</button>
        </div>
    </div>

    <script>
        // Updated URL for the specific spreadsheet and GID
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSombdppmWqAYqrvhAFj7P1Samea_9O1i2sJyU1EsLhiPsuS1T6KaW4QiVlV1XN08xSGzX8fNL7kZqU/pub?gid=2027661700&single=true&output=csv';
        const WHATSAPP_NUM = '919980764752';
        let allItems = [];
        let currentCategory = 'All';

        function formatDriveUrl(url) {
            if (!url || !url.includes('drive.google.com')) return url;
            try {
                const id = url.match(/[-\w]{25,}/)[0];
                return `https://docs.google.com/uc?export=view&id=${id}`;
            } catch (e) { return url; }
        }

        async function loadData() {
            try {
                const response = await fetch(SHEET_URL);
                const data = await response.text();
                const rows = data.split(/\r?\n/).filter(r => r.trim()).slice(1);
                
                const categories = new Set();

                allItems = rows.map(row => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    const name = cols[0]?.replace(/"/g, '').trim();
                    const category = cols[8]?.replace(/"/g, '').trim() || 'Essentials'; // Column I
                    
                    if (category) categories.add(category);

                    return {
                        name: name,
                        price: parseFloat(cols[2]) || 0,        
                        unit: cols[3]?.trim() || 'kg',          
                        img: formatDriveUrl(cols[5]?.trim()),   
                        stock: cols[7]?.trim().toLowerCase(),
                        category: category
                    };
                }).filter(i => i.name && i.stock !== 'out');
                
                updateCategoryTabs(Array.from(categories));
                render(allItems);
            } catch (e) { console.error("Data error", e); }
        }

        function updateCategoryTabs(cats) {
            const container = document.getElementById('category-tabs');
            container.innerHTML = `<div onclick="setCategory('All')" class="category-tab active-tab" id="tab-All">All</div>` +
                cats.map(cat => `<div onclick="setCategory('${cat}')" class="category-tab" id="tab-${cat.replace(/\s+/g, '')}">${cat}</div>`).join('');
        }

        function setCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active-tab'));
            const safeId = cat.replace(/\s+/g, '');
            document.getElementById('tab-' + safeId).classList.add('active-tab');
            filterVeg();
        }

        function render(items) {
            const container = document.getElementById('shop-container');
            container.innerHTML = items.map(item => `
                <div class="veg-card p-3 shadow-sm flex flex-col">
                    <img src="${item.img}" class="w-full h-32 object-cover rounded-lg mb-2 bg-gray-100" onerror="this.src='https://via.placeholder.com/300?text=${item.name}'">
                    <h3 class="font-bold text-gray-800 text-xs md:text-sm truncate">${item.name}</h3>
                    <p class="text-green-700 font-bold mb-2">‚Çπ${item.price}/${item.unit}</p>
                    <input type="number" min="0" step="any" placeholder="Qty" oninput="updateTotal()" 
                           id="qty-${item.name.replace(/\s+/g, '-')}"
                           data-name="${item.name}" data-price="${item.price}" 
                           class="qty-input w-full border p-2 text-center rounded-lg outline-none focus:border-green-600">
                </div>
            `).join('');
        }

        function filterVeg() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            let filtered = allItems;
            if (currentCategory !== 'All') filtered = filtered.filter(i => i.category === currentCategory);
            if (q) filtered = filtered.filter(i => i.name.toLowerCase().includes(q));
            render(filtered);
        }

        function updateTotal() {
            let total = 0;
            document.querySelectorAll('.qty-input').forEach(i => total += (parseFloat(i.value) || 0) * parseFloat(i.dataset.price));
            document.getElementById('total-val').innerText = total.toFixed(2);
            document.getElementById('cart-total').style.display = total > 0 ? 'block' : 'none';
        }

        function toggleCart(show) {
            document.getElementById('cart-sidebar').classList.toggle('active', show);
            if(show) {
                let html = "";
                document.querySelectorAll('.qty-input').forEach(i => {
                    if(parseFloat(i.value) > 0) html += `<div class="flex justify-between border-b pb-2 text-sm"><span>${i.dataset.name} x ${i.value}</span><b>‚Çπ${(i.value * i.dataset.price).toFixed(2)}</b></div>`;
                });
                document.getElementById('cart-list').innerHTML = html || "Basket is empty";
            }
        }

        function toggleHistory(show) { 
            document.getElementById('order-history-sidebar').classList.toggle('active', show);
            if(show) {
                const history = JSON.parse(localStorage.getItem('vs_orders') || '[]');
                document.getElementById('vendor-tools').classList.toggle('hidden', history.length === 0);
            }
        }

        function clearHistory() {
            if(confirm("Clear history?")) { localStorage.removeItem('vs_orders'); searchHistory(); toggleHistory(false); }
        }

        function getLocation() {
            const status = document.getElementById('geo-status');
            if (!navigator.geolocation) { status.textContent = "GPS not supported"; return; }
            status.textContent = "Locating...";
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById('cust_address').value = `üìç GPS: https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
                    status.textContent = "Linked!";
                },
                () => { status.textContent = "Allow access."; }
            );
        }

        function sendOrder() {
            const name = document.getElementById('cust_name').value || "Customer";
            const phone = document.getElementById('cust_phone').value || "N/A";
            const address = document.getElementById('cust_address').value || "Manual Delivery";
            const total = document.getElementById('total-val').innerText;
            
            let itemStr = "";
            let itemsForStorage = [];
            document.querySelectorAll('.qty-input').forEach(i => {
                const val = parseFloat(i.value);
                if(val > 0) {
                    itemStr += `‚Ä¢ ${i.dataset.name}: ${val}\n`;
                    itemsForStorage.push({name: i.dataset.name, qty: val});
                }
            });

            const history = JSON.parse(localStorage.getItem('vs_orders') || '[]');
            history.push({ date: new Date().toLocaleString(), phone: phone, items: itemsForStorage, total: total });
            localStorage.setItem('vs_orders', JSON.stringify(history));

            const msg = encodeURIComponent(`*ORDER - V.S. VEGETABLE MART*\nüë§ Name: ${name}\nüìû Phone: ${phone}\nüìç Location: ${address}\n\n*ITEMS:*\n${itemStr}\n*TOTAL: ‚Çπ${total}*`);
            window.open(`https://wa.me/${WHATSAPP_NUM}?text=${msg}`);
        }

        function reorder(index) {
            const searchPhone = document.getElementById('history_search_phone').value.trim();
            const history = JSON.parse(localStorage.getItem('vs_orders') || '[]').filter(o => o.phone.includes(searchPhone)).reverse();
            const order = history[index];
            if(!order) return;
            document.querySelectorAll('.qty-input').forEach(input => input.value = "");
            order.items.forEach(item => {
                const input = document.getElementById(`qty-${item.name.replace(/\s+/g, '-')}`);
                if(input) input.value = item.qty;
            });
            updateTotal();
            toggleHistory(false);
            toggleCart(true);
        }

        function searchHistory() {
            const searchPhone = document.getElementById('history_search_phone').value.trim();
            const history = JSON.parse(localStorage.getItem('vs_orders') || '[]').filter(o => o.phone.includes(searchPhone)).reverse();
            const resultsBox = document.getElementById('history-results');
            if(!searchPhone) { resultsBox.innerHTML = "Enter phone number."; return; }
            if(history.length === 0) { resultsBox.innerHTML = "No orders found."; return; }
            resultsBox.innerHTML = history.map((o, idx) => `
                <div class="bg-gray-50 p-4 rounded-xl border-l-4 border-green-600 shadow-sm mb-4">
                    <div class="flex justify-between text-xs text-gray-500 mb-2"><span>${o.date}</span><b>‚Çπ${o.total}</b></div>
                    <p class="text-sm font-bold mb-2">${o.items.map(i => i.name + ' (' + i.qty + ')').join(', ')}</p>
                    <div class="flex justify-between items-center"><span class="text-xs">Phone: ${o.phone}</span><button onclick="reorder(${idx})" class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold uppercase">Re-order</button></div>
                </div>`).join('');
        }

        loadData();
    </script>
</body>
</html>
